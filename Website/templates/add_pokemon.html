<!DOCTYPE html>
<html lang="en">
    <p style="position: absolute; top: 0; left: 0;">game Id: {{ gameId }}</p>
<head>
    <meta charset="UTF-8">
    <title>Create Pokémon</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
        }
        h1 {
            text-align: center;
        }
        form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        label { font-weight: bold; }
        input, select { padding: 6px; width: 95%; }
        .full { grid-column: span 2; }
        button {
            padding: 10px 15px;
            margin-top: 15px;
            font-size: 16px;
        }
    </style>
</head>

<body>

<h1>Create Pokémon</h1>

<form id="pokemonForm">

    <!-- Base Pokémon FK -->
    <label>Species</label>
    <select id="BasePokemonId" name="basePokemonId" required>
        <option value="">Loading...</option>
    </select>

    <!-- Nickname -->
    <label>Nickname</label>
    <input name="name">

    <label>Level</label>
    <input name="level" type="number" value="1">

    <label>Gender</label>
    <select name="gender">
        <option value="None">None</option>
        <option value="Male">Male</option>
        <option value="Female">Female</option>
    </select>

    <label>Age</label>
    <input name="age" type="number" value="0">

    <!-- Nature FK -->
    <label>Nature</label>
    <select id="NatureId" name="natureId">
        <option value="">Loading...</option>
    </select>

    <!-- Ability FK -->
    <label>Ability</label>
    <select id="AbilityId" name="abilityId">
        <option value="">Loading...</option>
    </select>

    <!-- Status Enum -->
    <label>Status</label>
    <select id="Status" name="status"></select>

    <label>Will</label><input name="will" type="number" value="3">
    <label>Logic</label><input name="logic" type="number" value="1">

    <label>Instinct</label><input name="instinct" type="number" value="1">
    <label>Primal</label><input name="primal" type="number" value="0">

    <!-- Item FK -->
    <label>Held Item</label>
    <select id="ItemId" name="itemId">
        <option value="">None</option>
    </select>

    <!-- Garments FK -->
    <label>Garment 1</label>
    <select id="Garment1" name="Garment1"></select>

    <label>Garment 2</label>
    <select id="Garment2" name="Garment2"></select>

    <label>Garment 3</label>
    <select id="Garment3" name="Garment3"></select>

    <label>Is NPC?</label>
    <select name="isNpc">
        <option value="false">False</option>
        <option value="true">True</option>
    </select>

    <label>Experience Points</label>
    <input name="experiencePoints" type="number" value="0">

    <label>Player Color</label>
    <input name="playerColor" type="text" value="None">

    <label>Guid</label>
    <input name="Guid" type="text" value="">
    <input type="hidden" name="gameId" id="GameId" value="{{ gameId }}">

    <button class="full" type="submit">Submit Pokémon</button>

</form>

<script>
async function loadSelect(selectId, url, labelField = "name") {
    const sel = document.getElementById(selectId);
    sel.innerHTML = `<option value="">Loading...</option>`;
    try {
        const res = await fetch(url);
        const data = await res.json();

        sel.innerHTML = ""; // clear old content

        data.forEach((item, index) => {
            const opt = document.createElement("option");
            opt.value = item.id === null ? "" : item.id;
            opt.textContent = item[labelField];

            // default select the "None" entry
            if (index === 0) opt.selected = true;

            sel.appendChild(opt);
        });

    } catch (err) {
        sel.innerHTML = `<option>Error loading</option>`;
    }
}


function loadEnum(selectId, values) {
    const sel = document.getElementById(selectId);
    sel.innerHTML = "";
    values.forEach(v => {
        sel.innerHTML += `<option value="${v}">${v}</option>`;
    });
}

async function loadAllFKs() {
    const tmp1 = loadSelect("BasePokemonId", "http://127.0.0.1:9000/basePokemon");
    const tmp2 = loadSelect("NatureId", "http://127.0.0.1:9000/nature");
    const tmp3 = loadSelect("AbilityId", "http://127.0.0.1:9000/ability");
    const tmp4 = loadSelect("ItemId", "http://127.0.0.1:9000/item");
    const tmp5 = loadSelect("Garment1", "http://127.0.0.1:9000/garment");
    const tmp6 = loadSelect("Garment2", "http://127.0.0.1:9000/garment");
    const tmp7 = loadSelect("Garment3", "http://127.0.0.1:9000/garment");

    await Promise.all([tmp1, tmp2, tmp3, tmp4, tmp5, tmp6, tmp7])

    const statusValues = [
        "Healthy","Burn1","Burn2","Burn3","Poisoned",
        "Badly Poisoned","Frozen","Asleep","Paralyzed",
        "Confused","Disabled","Flinched","In Love"
    ];

    loadEnum("Status", statusValues);
}

document.addEventListener("DOMContentLoaded", loadAllFKs);

document.getElementById("pokemonForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const form = new FormData(e.target);
    const json = {};

    for (const [key, val] of form.entries()) {
        if (val === "") continue;

        if (val === "true" || val === "false") {
            json[key] = val === "true";
        } else if (!isNaN(val)) {
            json[key] = Number(val);
        } else {
            json[key] = val;
        }
    }

    // Combine garments (if your API wants an array)
    json["garments"] = [form.get("Garment1"), form.get("Garment2"), form.get("Garment3")]
        .filter(v => v !== "");

    const res = await fetch("http://127.0.0.1:9000/gamePokemon", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(json)
    });

    const result = await res.json();
    alert("Server response: " + JSON.stringify(result, null, 2));
});
</script>

</body>
</html>
